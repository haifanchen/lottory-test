<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>后台 – 订单奖品映射</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;margin:40px;background:#f5f7fa}
h1{margin-top:0}
button{padding:8px 16px;border:none;border-radius:4px;background:#3f51b5;color:#fff;font-size:14px;cursor:pointer;margin-right:10px}
table{width:100%;border-collapse:collapse;font-size:14px;margin-top:20px}
th,td{padding:6px 4px;text-align:center;border-bottom:1px solid #eee}
th{background:#f9fafb}
</style>
</head>
<body>
<h1>后台 – 订单奖品映射（实时读取 orders.csv）</h1>
<button onclick="downloadCSV()">下载 CSV</button>
<table id="resultTable">
  <thead><tr><th>订单号</th><th>奖品</th></tr></thead>
  <tbody></tbody>
</table>

<script>
/* ===== 与 index.html 完全一致的数据与算法 ===== */
const SEED = 20250805;                        // 与 index.html 同步
const PRIZE_POOL = [
  { name:'【7月冲刺享整年免费换电券】', stock:3 },
  { name:'【蔚来悦享出行兑换券】', stock:31 },
  { name:'【NIO SUMMER套票】', stock:30 },
  { name:'【NIO LIFE行李箱】', stock:17 },
  { name:'【米家扫地机器人】', stock:1 },
  { name:'【星巴克兑换券】', stock:146 },
  { name:'【5张免费换电券】', stock:100 },
  { name:'【蛇年ip马克杯】', stock:382 }
];

/* ===== 洗牌算法 ===== */
function shuffle(arr, seed) {
  let rng = seed;
  const random = () => {
    rng = (rng * 9301 + 49297) % 233280;
    return rng / 233280;
  };
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

/* ===== 运行时读取 orders.csv ===== */
let ORDER_LIST = [];
let PRIZE_MAP  = {};

fetch('orders.csv')
  .then(r => r.text())
  .then(text => {
    ORDER_LIST = text.trim().split(/\r?\n/).slice(1).map(l => l.trim());
    // 生成奖品数组
    let prizes = [];
    PRIZE_POOL.forEach(p => {
      for (let i = 0; i < p.stock; i++) prizes.push(p.name);
    });
    // 洗牌后映射
    const shuffled = shuffle(prizes, SEED);
    ORDER_LIST.forEach((ord, idx) => {
      PRIZE_MAP[ord] = shuffled[idx] || '暂无奖品';
    });
    // 渲染表格
    const tbody = document.querySelector('#resultTable tbody');
    ORDER_LIST.forEach(ord => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${ord}</td><td>${PRIZE_MAP[ord]}</td>`;
      tbody.appendChild(tr);
    });
  })
  .catch(err => console.error('读取 orders.csv 失败', err));

/* ===== CSV 导出 ===== */
function downloadCSV() {
  if (!ORDER_LIST.length) return alert('暂无数据');
  let csv = '订单号,奖品\n';
  ORDER_LIST.forEach(ord => csv += `${ord},"${PRIZE_MAP[ord]}"\n`);
  const blob = new Blob(['\ufeff' + csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = '订单奖品映射.csv';
  a.click();
}
</script>
</body>
</html>